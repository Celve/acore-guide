# 特权级机制

我们已经在[操作系统简介](os_intro.md#用户态内核态)中介绍了特权级及其作用。我们知道，特权级机制可以保证应用的运行不会影响到内核或者其他的应用。

整个特权级机制是通过硬件加上指令集支持实现的。CPU 有一些特殊的寄存器，叫做 CSR (Control and Status Register)，用于控制和记录特权相关的状态。

我们将从高特权态到低特权态的操作称为 `eret` (environment return)，将低特权态到高特权态的操作成为 `ecall`。

## 特权指令

RISCV 大致提供这些特权指令：

| 指令 | 描述 |
|:---:| --- |
| `ecall` | 从低特权态进入高特权态 |
| `ebreak` | 用于调试 |
| `mret` | 从机器态到低特权态，在特权态不正确的情况下执行会产生非法指令异常 |
| `sret` | 从监管态到低特权态，在特权态不正确的情况下执行会产生非法指令异常 |
| `wfi` | 等待中断，在 U mode 下执行会产生非法指令异常 |
| `sfence.vma` | 刷新 TLB，在 U mode 下执行会产生非法指令异常 |
| `csrr` | 读取 CSR（到通用寄存器） |
| `csrw` | 写入 CSR（从通用寄存器） |
| `csrrw` | 读取 CSR 并写入 CSR，这个过程是原子的 |
